# 工单组件字段功能更新

## 更新内容

### 1. SAP接口集成
- 新增 SAP API 服务模块，支持根据工单号获取物料信息
- 在添加工单和紧急插单表单中集成 SAP 接口
- 输入工单号后按回车自动获取物料号、物料名称和数量

### 2. 数据库更新
- 在 `orders` 表中添加了 `orderComponent` 字段（VARCHAR(255)）
- 支持存储工单组件信息

### 2. 后端API更新
- 更新了工单的增删改查API，支持工单组件字段
- 在 `server.js` 中添加了数据库字段自动迁移逻辑

### 3. 前端界面更新

#### 工单表单
- 在添加工单和编辑工单表单中添加了"工单组件"输入字段
- 在紧急插单表单中也添加了工单组件字段

#### 工单列表显示
- 在工单管理页面的表格中添加了"工单组件"列
- 在工单数据表中添加了工单组件显示
- 支持显示工单组件信息，未设置时显示"-"

#### 下达工单功能
- **核心功能**：工单组件自动带入物料编码字段
- **核心功能**：物料号自动带入产成品编码字段
- 优化了下达工单界面，显示工单信息和字段来源
- 改进了验证逻辑，提供更清晰的错误提示

#### 导出功能
- Excel导出功能中包含了工单组件字段
- 调整了列宽以适应新字段

## 功能说明

### 自动带入逻辑
1. **工单组件 → 物料编码**：在下达工单时，工单组件字段的值会自动填入物料编码字段
2. **物料号 → 产成品编码**：在下达工单时，物料号字段的值会自动填入产成品编码字段

### SAP接口自动获取
1. **工单号 → 物料信息**：输入工单号后按回车，自动从 SAP 系统获取：
   - 物料号 (MATNR)
   - 物料名称 (MAKTX)
   - 数量 (GAMNG)

### 下达工单自动带入逻辑
1. **工单组件 → 物料编码**：在下达工单时，工单组件字段的值会自动填入物料编码字段
2. **物料号 → 产成品编码**：在下达工单时，物料号字段的值会自动填入产成品编码字段

### 使用流程
1. 在添加工单时：
   - 输入工单号后按回车，系统自动从 SAP 获取物料信息
   - 手动填写"工单组件"字段
2. 在下达工单时，系统会自动：
   - 将工单组件的值带入到物料编码字段
   - 将物料号的值带入到产成品编码字段
3. 用户可以在下达前检查和修改这些自动填入的值

## 技术实现

### 数据库字段
```sql
ALTER TABLE orders ADD COLUMN orderComponent VARCHAR(255);
```

### SAP 接口集成
```javascript
// 在 sapApi.js 中
export const sapApi = {
  async getOrderMaterial(orderNo) {
    const data = {
      "Code": "MM_BARCODE_PROWH_READ",
      "UserId": "12552",
      "np_code2migo": [{
        "IvInput": `{"AUFNR":"${orderNo}"}`,
        "EvOutput": ""
      }]
    };
    // ... API 调用逻辑
  }
};
```

### 前端自动填充逻辑
```javascript
// 在SubmitWorkOrderModal组件中
React.useEffect(() => {
  if (order) {
    const machine = machines.find(m => m.name === order.machine);
    setFormData({
      orderId: order.orderNo || '',
      materialId: order.orderComponent || '', // 工单组件自动带入物料编码
      nextmaterialId: order.materialNo || '', // 物料号自动带入产成品编码
      quantity: order.quantity || '',
      equipment: machine?.lineCode || '',
      priority: order.priority || '',
      radio: 0
    });
  }
}, [order, machines]);
```

## 注意事项

1. **SAP 接口配置**：需要确保 SAP 系统可访问，并更新 CSRF Token 和 Session ID
2. **网络访问**：由于使用 HTTPS 和自签名证书，可能需要在浏览器中允许不安全内容
3. 现有工单的工单组件字段为空，不影响现有功能
4. 下达工单时会显示字段来源，便于用户理解自动填充逻辑
5. 所有相关的表格和导出功能都已更新以支持新字段
6. 数据库迁移会在服务器启动时自动执行

## 测试建议

1. **SAP 接口测试**：
   - 输入有效的工单号（如 1100149640）后按回车
   - 验证是否能自动获取物料号、物料名称和数量
2. 创建新工单时填写工单组件字段
3. 测试下达工单功能，验证自动带入逻辑
4. 检查工单列表显示是否正确
5. 测试Excel导出功能是否包含新字段